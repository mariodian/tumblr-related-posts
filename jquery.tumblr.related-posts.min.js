/*!
 * Merge Sort in JavaScript v1.0
 * http://github.com/justinforce/merge-sort
 *
 * Copyright (c) 2011, Justin Force
 * Licensed under the BSD 3-Clause License
 */(function(){"use strict";Array.mergeSort||(Array.prototype.mergeSort=function(e){function r(e,t,n){var r=[];while(e.length>0||t.length>0)if(e.length>0&&t.length>0)if(n(e[0],t[0])<=0){r.push(e[0]);e=e.slice(1)}else{r.push(t[0]);t=t.slice(1)}else if(e.length>0){r.push(e[0]);e=e.slice(1)}else if(t.length>0){r.push(t[0]);t=t.slice(1)}return r}var t=this.length,n=Math.floor(t/2);e||(e=function(e,t){return e<t?-1:e===t?0:1});return t<2?this:r(this.slice(0,n).mergeSort(e),this.slice(n,t).mergeSort(e),e)});if(window.jQuery!==undefined){jQuery.fn.mergeSort=function(e){return jQuery(Array.prototype.mergeSort.call(this,e))};jQuery.mergeSort=function(e,t){return Array.prototype.mergeSort.call(e,t)}}})();$.fn.relatedPosts=function(e){var t=$.extend({tumblrSite:location.hostname,maxPosts:5,header:"Related posts",headerTag:"h3",titleTag:"h4",showImage:!0,postLength:200,deleteOnEmpty:!0,tags:""},e),n=this,r=t.tags.split(","),i=new Array;r.pop();var s=function(e,t){e.sort(function(e,n){return e[t]-n[t]});for(var n=0;n<e.length-1;n++)e[n][t]==e[n+1][t]&&delete e[n];return e.filter(function(e){return typeof e!="undefined"})},o=function(){i=i.filter(function(e){return e.id!=t.postID});i=s(i,"id");i.sort(function(e,t){return e.id<t.id?1:-1});var e;for(var o=r.length-1;o>=0;o--)e=i.mergeSort(function(e,t){return e.tags[o]==r[o]||t.tags[o]==e.tags[o]?-1:1});var u=e.length;if(u){$(n).show();$(n).append("<"+t.headerTag+">"+t.header+"</"+t.headerTag+">");$(n).append("<ul />");var a=$(n).find("ul");for(var o=0;o<(u>t.maxPosts?t.maxPosts:u);o++){var f=e[o],l=null,c="",h="",p=f.body!=null?f.body:"",d=f.title!=null?f.title:"";if(p!=null){l=/img.*?src=[\'|\"]+([^'"]+)[\'|\"]+/.exec(p);c="";l!=null&&t.showImage&&(c='<a href="'+f.post_url+'"><img src="'+l[1]+'" alt="'+d+'"></a>');h=p.replace(/<.*?>+/g,"").substr(0,t.postLength);h+="..."}a.append("<li>"+c+"<"+t.titleTag+'><a href="'+f.post_url+'">'+d+"</a></"+t.titleTag+"><p>"+h+' <a href="'+f.post_url+'">Read more</a></p></li>')}}else t.deleteOnEmpty&&$(n).remove()},u=function(e){var t=e.response.posts;for(var n=0;n<t.length;n++)i.push(t[n])};$.ajaxSetup({cache:!1});jQuery.ajaxPrefilter(function(e){e.global=!0});$(document).ajaxStop(function(){o()});for(var a=0;a<r.length;a++)$.ajax({type:"GET",url:"http://api.tumblr.com/v2/blog/"+t.tumblrSite+"/posts",dataType:"jsonp",data:{api_key:t.apiKey,tag:r[a],limit:t.maxPosts},success:function(e){u(e)}})};